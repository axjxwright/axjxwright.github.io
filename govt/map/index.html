<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AX Map Test</title>
    <script src="./assets/data.js"></script>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pathway+Gothic+One&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link href="./style.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var geojson = {
        type: "FeatureCollection",
        features: [],
      };
      var offset = 0;
      for (const decade in kData) {
        for (var i = 0; i < kData[decade].length; i++) {
          // Create a DOM element for each marker.
          var pl = kData[decade][i];
          if (isNaN(pl.lat) || isNaN(pl.lng)) continue;
          var elem = {
            type: "Feature",
            properties: {
              //cluster: true,
              base_id: 99999 + offset,
              ...pl,
            },
            geometry: {
              type: "Point",
              coordinates: [parseFloat(pl.lng), parseFloat(pl.lat)],
            },
          };
          offset++;

          geojson.features.push(elem);
        }
      }

      const markers = {};
      let markersOnScreen = {};
      var center = [kData["1810"][0].lng, kData["1810"][0].lat];

      function updateMarkers() {
        const newMarkers = {};
        const features = map.querySourceFeatures("earthquakes");

        for (const feature of features) {
          const coords = feature.geometry.coordinates;
          const props = feature.properties;
          if (props.cluster) continue;
          const id = props.cluster ? props.cluster_id : props.base_id;

          let marker = markers[id];
          if (!marker) {
            const el = createMarkerDiv(feature);
            marker = markers[id] = new mapboxgl.Marker({
              element: el,
            }).setLngLat(coords);
          }
          newMarkers[id] = marker;

          if (!markersOnScreen[id]) marker.addTo(map);
        }

        for (const id in markersOnScreen) {
          if (!newMarkers[id]) markersOnScreen[id].remove();
        }
        markersOnScreen = newMarkers;
      }

      mapboxgl.accessToken =
        "pk.eyJ1IjoiYXhpbnRlcmFjdGl2ZSIsImEiOiJja3kzd3d4NmkwNTc2Mm5xZXFoNmNibzFqIn0.bINBomFPiUbdNRidFfW8zg";
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/axinteractive/claggyjr3000315rsodynbq4u", // style URL
        center: center,
        zoom: 9,
      });

      map.on("load", () => {
        map.addSource("earthquakes", {
          type: "geojson",
          data: geojson,
          cluster: true,
          clusterRadius: 25,
          clusterMaxZoom: 10,
        });

        map.on("render", () => {
          if (!map.isSourceLoaded("earthquakes")) return;
          updateMarkers();
        });

        map.addLayer({
          id: "clusters",
          type: "circle",
          source: "earthquakes",
          filter: ["has", "point_count"],
          paint: {
            "circle-color": [
              "step",
              ["get", "point_count"],
              "#51bbd6",
              100,
              "#f1f075",
              750,
              "#f28cb1",
            ],
            "circle-radius": [
              "step",
              ["get", "point_count"],
              20,
              100,
              30,
              750,
              40,
            ],
          },
        });

        map.addLayer({
          id: "cluster-count",
          type: "symbol",
          source: "earthquakes",
          filter: ["has", "point_count"],
          layout: {
            "text-field": ["get", "point_count_abbreviated"],
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12,
          },
        });

        map.addLayer({
          id: "unclustered-point",
          type: "circle",
          source: "earthquakes",
          filter: ["!", ["has", "point_count"]],
          paint: {
            "circle-color": "#11b4da",
            "circle-radius": 16,
            "circle-stroke-width": 1,
            "circle-stroke-color": "#fff",
          },
        });
      });

      map.on("click", "clusters", function (e) {
        var features = map.queryRenderedFeatures(e.point, {
          layers: ["clusters"],
        });
        var clusterId = features[0].properties.cluster_id;
        map
          .getSource("earthquakes")
          .getClusterExpansionZoom(clusterId, function (err, zoom) {
            if (err) return;

            map.easeTo({
              center: features[0].geometry.coordinates,
              zoom: zoom,
            });
          });
      });

      let iconSize = 32;

      map.on("click", "unclustered-point", (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();

        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        var d = e.features[0].properties;
        var html = `<li class='right'><div>
        <time>${d.open_date}</time>
        <p>
          <span class='bolder'>${d.common_name || ""}</span>
          </p><p>
          <span class='faded'>${d.suburb || ""} </span> 
          <span >${d.designer || ""} </span>
          </p>
        </p>
        <p>
          
        </p>
        <img class='preview-img' src="assets/images/${d.image}"/>
      </div></li>`;

        new mapboxgl.Popup().setLngLat(coordinates).setHTML(html).addTo(map);

        map.easeTo({
          center: e.features[0].geometry.coordinates,
          zoom: map.getZoom(),
        });
      });

      map.on("mouseenter", "clusters", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "clusters", () => {
        map.getCanvas().style.cursor = "";
      });

      map.on("mouseenter", "unclustered-points", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "unclustered-points", () => {
        map.getCanvas().style.cursor = "";
      });

      function createMarkerDiv(feature) {
        var pl = feature.properties;
        if (pl.cluster) {
          const el = document.createElement("div");
          const width = iconSize * 1.5;
          const height = iconSize * 1.5;
          el.className = "cluster";
          el.style.backgroundColor = "#ff0000";
          el.style.width = `${width}px`;
          el.style.height = `${height}px`;
          el.id = "marker-" + pl.base_id;

          return el;
        } else {
          const el = document.createElement("div");
          const width = iconSize;
          const height = iconSize;
          el.className = "marker";
          el.style.backgroundImage = `url(./assets/images/${pl.image})`;
          el.style.width = `${width}px`;
          el.style.height = `${height}px`;

          return el;
        }
      }
    </script>
  </body>
</html>
